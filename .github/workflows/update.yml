name: Update Tap

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap Repo
        run: brew tap ${{ github.repository_owner }}/$(basename $GITHUB_REPOSITORY) .

      - name: Check/Update Tap
        run: |
          updated=0
          for file in Formula/*.rb Casks/*.rb; do
            name=$(basename "$file" .rb)
            echo "Checking $name..."
      
            result=$(brew livecheck --json "$name" 2>/dev/null | jq '.[0]' 2>/dev/null || echo '{}')
      
            if [[ "$result" == "{}" ]]; then
              echo "‚ö†Ô∏è  Livecheck failed for $name, skipping..."
              continue
            fi
      
            current=$(echo "$result" | jq -r '.version.current // empty')
            latest=$(echo "$result" | jq -r '.version.latest // empty')
      
            if [[ -z "$current" || -z "$latest" || "$current" == "$latest" || "$latest" == "null" ]]; then
              continue
            fi
      
            echo "Updating $name: $current ‚Üí $latest"
      
            if [[ "$file" == Formula/* ]]; then
              if brew bump-formula-pr "$name" --version="$latest" --write-only --no-audit --no-browse 2>/dev/null; then
                echo "‚úÖ Successfully updated formula $name"
                updated=1
              else
                echo "‚ùå Failed to update formula $name"
              fi
            else
              if brew bump-cask-pr "$name" --version="$latest" --write-only --no-audit --no-browse 2>/dev/null; then
                echo "‚úÖ Successfully updated cask $name"
                updated=1
              else
                echo "‚ùå Failed to update cask $name"
              fi
            fi
          done
      
          if [[ "$updated" -eq 1 ]]; then
            git add -A
  
            if ! git diff --cached --quiet; then
              git commit -m "chore: auto-update formulas and casks"
              git push
              echo "üöÄ Changes pushed successfully"
            else
              echo "‚ÑπÔ∏è  No changes to commit"
            fi
          else
            echo "‚úÖ All formulas and casks are up to date."
          fi
