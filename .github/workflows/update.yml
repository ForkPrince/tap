name: Update Tap

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap Repo
        run: brew tap ${{ github.repository_owner }}/$(basename $GITHUB_REPOSITORY) .

      - name: Check/Update Tap
        run: |
          set -e
          updated=0

          for file in Formula/*.rb Casks/*.rb; do
            name=$(basename "$file" .rb)
            echo "üîç Checking $name..."

            result=$(brew livecheck --json "$name" 2>/dev/null || true)
            current=$(echo "$result" | jq -r '.[0].version.current')
            latest=$(echo "$result" | jq -r '.[0].version.latest')
            url=$(echo "$result" | jq -r '.[0].urls.stable.url // empty')

            if [[ "$current" != "$latest" && "$latest" != "null" && -n "$url" ]]; then
              echo "‚¨ÜÔ∏è  Updating $name: $current ‚Üí $latest"

              new_url=$(echo "$url" | sed "s/$current/$latest/g")
              tmpfile=$(mktemp)

              if curl -Lso "$tmpfile" "$new_url"; then
                new_sha256=$(shasum -a 256 "$tmpfile" | awk '{ print $1 }')

                echo "  ‚úèÔ∏è Updating file: $file"
                sed -i "s|version \".*\"|version \"$latest\"|" "$file"
                sed -i "s|url \".*\"|url \"$new_url\"|" "$file"
                sed -i "s|sha256 \".*\"|sha256 \"$new_sha256\"|" "$file"

                updated=1
              else
                echo "  ‚ö†Ô∏è Failed to fetch $new_url"
              fi
            fi
          done

          if [[ "$updated" -eq 1 ]]; then
            git add Formula/*.rb Casks/*.rb
            git commit -m "chore: auto-update formulas and casks"
            git push origin HEAD
          else
            echo "‚úÖ All formulas and casks are up to date."
          fi
